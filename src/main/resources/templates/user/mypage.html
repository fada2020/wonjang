<!DOCTYPE HTML>
<html xmlns:th="http://www.thymeleaf.org" th:replace="~{user/layout/layout::layout( ~{::title}, ~{::link}, ~{::style}, ~{::body}, ~{::script}, ~{::meta})}">

<title>마이 페이지</title>
<body>

<div class="container mt-5">
  <h2 class="text-center mb-4">내 정보</h2>

  <div class="card">
    <div class="card-body">
      <form method="post" th:object="${updateMemberDto}" enctype="multipart/form-data" onsubmit="return checkValues(this)">
        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>

        <!-- 이메일 -->
        <div class="form-group">
          <label th:for="email">이메일</label>
          <input type="email" class="form-control" th:id="email" th:name="email" th:value="${member.email}" readonly />
        </div>

        <!-- 이름 -->
        <div class="form-group">
          <label th:for="name">이름</label>
          <input type="text" class="form-control" th:id="name" th:name="name" th:value="${member.name}" required />
        </div>

        <!-- 학력 -->
        <div class="form-group">
          <label th:for="degree">학력</label>
          <select class="form-control" th:id="degree" th:name="degree" required>
            <option value="">선택하세요</option>
            <option value="elementary" th:selected="${member.degree == 'elementary'}">초등학교</option>
            <option value="middle" th:selected="${member.degree == 'middle'}">중학교</option>
            <option value="high" th:selected="${member.degree == 'high'}">고등학교</option>
            <option value="university" th:selected="${member.degree == 'university'}">대학교</option>
            <option value="other" th:selected="${member.degree == 'other'}">기타</option>
          </select>
        </div>

        <!-- 학년 -->
        <div class="form-group" id="gradeGroup">
          <label th:for="grade">학년</label>
          <select class="form-control" th:name="grade" th:id="grade" required>
            <option th:each="year, index : ${yearsByDegree}" th:value="${year}" th:text="${year} + '학년'" th:selected="${ #strings.isEmpty(member.grade) ? false : year.toString() == member.grade.toString()}" />
          </select>
        </div>

        <!-- 비밀번호 -->
        <div class="form-group">
          <label th:for="password">비밀번호</label>
          <input type="password" class="form-control" th:field="*{password}" placeholder="비밀번호 변경 (선택)" />
        </div>

        <!-- 사진 -->
        <div class="form-group mt-4">
          <label th:for="pictureFile">사진 변경</label>
          <input type="file" class="form-control-file" th:field="*{pictureFile}" />
        </div>

        <!-- 수정 버튼 -->
        <div class="form-group text-center mt-4">
          <button type="submit" class="btn btn-primary w-100">수정 완료</button>
        </div>
      </form>
    </div>
  </div>

  <!-- 로그아웃 버튼 -->
  <th:block sec:authorize="isAuthenticated()">
    <a th:href="@{/logout}" id="logoutButton">로그아웃</a>
  </th:block>

</div>
</body>
<script>
  function checkValues(form){
    const email = form.email.value.trim();
    const password = form.password.value.trim();
    // 이메일 유효성 검사
    const emailRegex = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,4}$/;
    if (!emailRegex.test(email)) {
      alert("올바른 이메일 주소를 입력하세요.");
      form.email.focus();
      return false;  // 폼 제출을 막습니다
    }

    // 비밀번호가 비어 있는지 확인
    if (password === "") {
      alert("비밀번호를 입력하세요.");
      form.password.focus();
      return false;  // 폼 제출을 막습니다
    }

    return true;  // 유효성 검사를 통과하면 폼을 제출합니다
  }
  document.getElementById('degree').addEventListener('change', function() {
    const degree = this.value;
    changeGradeSelect(degree);
  });

  function changeGradeSelect(degree){
    const gradeSelect = document.getElementById('grade');
    const gradeGroup = document.getElementById('gradeGroup');
    // 기존 학년 옵션을 지웁니다.
    gradeSelect.innerHTML = '<option value="">학년을 선택하세요</option>';

    // 기타 선택 시 학년 선택란 숨기기
    if (degree === 'other') {
      gradeGroup.style.display = 'none';
      return; // 기타를 선택하면 학년 옵션을 더 이상 처리하지 않음
    } else {
      gradeGroup.style.display = 'block'; // 학년 선택란 표시
    }

    let years = [];

    // 학교에 따른 학년도 배열
    if (degree === 'elementary') {
      years = [1, 2, 3, 4, 5, 6]; // 초등학교 1학년부터 6학년까지
    } else if (degree === 'middle') {
      years = [1, 2, 3]; // 중학교 1학년부터 3학년까지
    } else if (degree === 'high') {
      years = [1, 2, 3]; // 고등학교 1학년부터 3학년까지
    } else if (degree === 'university') {
      years = [1, 2, 3, 4]; // 대학교 1학년부터 4학년까지
    }

    // 학년도를 동적으로 추가
    years.forEach(function(year) {
      const option = document.createElement('option');
      option.value = year;
      option.textContent = `${year}학년`;
      gradeSelect.appendChild(option);
    });
  }
</script>
</html>